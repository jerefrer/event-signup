{{define "content"}}
{{$data := .Data}}
{{$event := index $data "Event"}}
{{$allRegs := index $data "AllRegs"}}
{{$totalRegs := index $data "TotalRegs"}}

<div class="admin-header">
    <div class="header-left">
        <a href="/admin?lang={{lang}}" class="btn-back" title="{{t "back"}}"><i class="fa-solid fa-arrow-left"></i></a>
        <h1>{{t "section_registrations"}} â€” {{loc $event.TitleFR $event.TitleEN}}</h1>
    </div>
    <div class="admin-actions">
        {{if $totalRegs}}<a href="/admin/export?event_id={{$event.ID}}" class="btn btn-secondary"><i class="fa-solid fa-download"></i> {{t "registration_export_csv"}}</a>{{end}}
    </div>
</div>

<section class="panel">
    <div class="panel-header">
        <h2 class="panel-title">{{t "registration_total"}}: {{$totalRegs}}</h2>
        {{if $totalRegs}}<div style="position:relative;max-width:220px;">
            <input type="text" id="reg-search" class="form-input form-input-sm" placeholder="{{t "registration_search"}}" style="width:100%;padding-right:28px;">
            <button type="button" id="reg-search-clear" style="display:none;position:absolute;right:4px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:2px 4px;color:#999;font-size:14px;line-height:1;" title="Clear"><i class="fa-solid fa-xmark"></i></button>
        </div>{{end}}
    </div>
    <div class="panel-body">
        {{if not $totalRegs}}
        <p class="empty-state-sm">{{t "registration_no_regs"}}</p>
        {{else}}
        <div class="table-responsive">
            <table class="data-table" id="reg-table">
                <thead>
                    <tr>
                        <th class="sortable" data-col="0">{{t "registration_last_name"}}</th>
                        <th class="sortable" data-col="1">{{t "registration_first_name"}}</th>
                        <th class="sortable" data-col="2">{{t "registration_group"}}</th>
                        <th class="sortable" data-col="3">{{t "confirmation_task"}}</th>
                        <th class="sortable" data-col="4">{{t "registration_email"}}</th>
                        <th class="sortable" data-col="5">{{t "registration_phone"}}</th>
                        <th class="sortable" data-col="6">{{t "registration_date"}}</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {{range $allRegs}}
                    <tr>
                        <td>{{.LastName}}</td>
                        <td>{{.FirstName}}</td>
                        <td>{{loc .GroupTitle .GroupTitleEN}}</td>
                        <td>{{loc .TaskTitle .TaskTitleEN}}</td>
                        <td>{{.Email}}</td>
                        <td>{{.Phone}}</td>
                        <td data-sort="{{.CreatedAt.Unix}}">{{formatDateTime .CreatedAt}}</td>
                        <td>
                            <form method="POST" action="/admin/registrations/delete" class="inline-form" onsubmit="return confirm('{{t "registration_delete_confirm"}}')">
                                <input type="hidden" name="id" value="{{.ID}}">
                                <input type="hidden" name="event_id" value="{{$event.ID}}">
                                <button type="submit" class="btn btn-sm btn-danger"><i class="fa-solid fa-trash"></i> {{t "delete"}}</button>
                            </form>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{end}}
    </div>
</section>

{{if $totalRegs}}
<script>
(function() {
    var table = document.getElementById('reg-table');
    if (!table) return;
    var thead = table.querySelector('thead');
    var tbody = table.querySelector('tbody');
    var headers = thead.querySelectorAll('.sortable');
    // Default sort: by group (col 2) if any group is set, otherwise by last name (col 0)
    var hasGroups = Array.from(tbody.querySelectorAll('tr')).some(function(row) {
        return row.children[2] && row.children[2].textContent.trim() !== '';
    });
    var currentCol = hasGroups ? 2 : 0, ascending = true;

    // Set initial arrow on the correct header
    headers.forEach(function(h) { h.textContent = h.textContent.replace(/ [\u25B4\u25BE]$/, ''); });
    headers.forEach(function(h) {
        if (parseInt(h.getAttribute('data-col')) === currentCol) h.textContent += ' \u25B4';
    });

    headers.forEach(function(th) {
        th.style.cursor = 'pointer';
        th.addEventListener('click', function() {
            var col = parseInt(th.getAttribute('data-col'));
            if (col === currentCol) {
                ascending = !ascending;
            } else {
                currentCol = col;
                ascending = true;
            }
            sortTable(col, ascending);
            headers.forEach(function(h) { h.textContent = h.textContent.replace(/ [\u25B4\u25BE]$/, ''); });
            th.textContent += ascending ? ' \u25B4' : ' \u25BE';
        });
    });

    function sortTable(col, asc) {
        var rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort(function(a, b) {
            var cellA = a.children[col];
            var cellB = b.children[col];
            var va = cellA.getAttribute('data-sort') || cellA.textContent.trim().toLowerCase();
            var vb = cellB.getAttribute('data-sort') || cellB.textContent.trim().toLowerCase();
            if (!isNaN(va) && !isNaN(vb)) { va = parseFloat(va); vb = parseFloat(vb); }
            if (va < vb) return asc ? -1 : 1;
            if (va > vb) return asc ? 1 : -1;
            return 0;
        });
        rows.forEach(function(row) { tbody.appendChild(row); });
    }

    var search = document.getElementById('reg-search');
    var clearBtn = document.getElementById('reg-search-clear');
    if (search) {
        function filterRows() {
            var q = search.value.toLowerCase();
            clearBtn.style.display = q ? '' : 'none';
            var rows = tbody.querySelectorAll('tr');
            rows.forEach(function(row) {
                row.style.display = row.textContent.toLowerCase().indexOf(q) !== -1 ? '' : 'none';
            });
        }
        search.addEventListener('input', filterRows);
        clearBtn.addEventListener('click', function() {
            search.value = '';
            filterRows();
            search.focus();
        });
    }
})();
</script>
{{end}}
{{end}}
{{template "layout" .}}
