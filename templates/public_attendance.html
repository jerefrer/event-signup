{{define "content"}}
{{$data := .Data}}
{{$event := index $data "Event"}}
{{$att := index $data "Attendance"}}

<div class="event-header">
    <h1>{{loc $event.TitleFR $event.TitleEN}}</h1>
    <div class="event-meta">
        <span class="event-meta-item">&#x1F4C5; {{formatDate $event.EventDate}}</span>
        {{if $event.EventTime}}
        <span class="event-meta-item">&#x1F552; {{formatTime $event.EventTime}}</span>
        {{end}}
    </div>
    {{$desc := loc $event.DescriptionFR $event.DescriptionEN}}
    {{if $desc}}
    <div class="event-description">{{nl2br $desc}}</div>
    {{end}}
</div>

<div id="rsvp-confirmed" {{if not $att}}style="display:none"{{end}}>
    <div class="registered-card card">
        <div id="confirm-icon" class="confirmation-icon{{if and $att (not $att.Attending)}} confirmation-icon-cancel{{end}}" aria-hidden="true">{{if and $att $att.Attending}}&#x2713;{{else}}&#x2717;{{end}}</div>
        <h2 id="confirm-title">{{if and $att $att.Attending}}{{t "rsvp_confirmed_yes"}}{{else}}{{t "rsvp_confirmed_no"}}{{end}}</h2>
        <p><strong id="confirm-name">{{if $att}}{{$att.FirstName}} {{$att.LastName}}{{end}}</strong></p>
        <p id="confirm-message" style="color:#666;font-style:italic;{{if or (not $att) (not $att.Message)}}display:none{{end}}">{{if $att}}{{$att.Message}}{{end}}</p>
        <div class="registered-actions">
            <button type="button" class="btn btn-secondary" id="btn-change-rsvp"><i class="fa-solid fa-pencil"></i> {{t "rsvp_change"}}</button>
        </div>
    </div>
</div>

<form id="rsvp-form" method="POST" action="/rsvp?lang={{lang}}" class="signup-unified" {{if $att}}style="display:none"{{end}}>
    <input type="hidden" name="event_id" value="{{$event.ID}}">
    <section class="panel">
        <h2 class="panel-title">{{t "rsvp_title"}}</h2>
        <div class="panel-body">
            <div class="form-row">
                <div class="form-group">
                    <label for="first_name">{{t "registration_first_name"}} *</label>
                    <input type="text" id="first_name" name="first_name" required class="form-input" autocomplete="given-name" {{if $att}}value="{{$att.FirstName}}"{{end}}>
                </div>
                <div class="form-group">
                    <label for="last_name">{{t "registration_last_name"}} *</label>
                    <input type="text" id="last_name" name="last_name" required class="form-input" autocomplete="family-name" {{if $att}}value="{{$att.LastName}}"{{end}}>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="email">{{t "registration_email"}} *</label>
                    <input type="email" id="email" name="email" required class="form-input" autocomplete="email" {{if $att}}value="{{$att.Email}}"{{end}}>
                </div>
                <div class="form-group">
                    <label for="phone">{{t "registration_phone"}}</label>
                    <input type="tel" id="phone" name="phone" class="form-input" autocomplete="tel" {{if $att}}value="{{$att.Phone}}"{{end}}>
                </div>
            </div>

            <div class="form-group" style="margin-top:1rem;">
                <label style="font-weight:600;margin-bottom:0.5rem;display:block;">{{t "rsvp_attending_label"}} *</label>
                <div class="rsvp-toggle">
                    <input type="radio" name="attending" value="yes" id="att-yes" required {{if and $att $att.Attending}}checked{{end}}>
                    <label for="att-yes">{{t "rsvp_attending_yes"}}</label>
                    <input type="radio" name="attending" value="no" id="att-no" required {{if and $att (not $att.Attending)}}checked{{end}}>
                    <label for="att-no">{{t "rsvp_attending_no"}}</label>
                </div>
            </div>

            <div class="form-group" style="margin-top:1rem;">
                <label for="message">{{t "rsvp_message"}}</label>
                <textarea id="message" name="message" rows="3" class="form-input" placeholder="{{t "rsvp_message_placeholder"}}">{{if $att}}{{$att.Message}}{{end}}</textarea>
            </div>
        </div>
    </section>

    <button type="submit" class="btn btn-primary btn-block"><i class="fa-solid fa-check"></i> {{t "rsvp_submit"}}</button>
</form>

<script>
(function() {
    var eventId = {{$event.ID}};
    var eventSlug = {{json $event.Slug}};
    var storageKey = 'rsvp_' + eventSlug;
    var userInfoKey = 'user_info';
    var confirmedYesMsg = {{json (t "rsvp_confirmed_yes")}};
    var confirmedNoMsg = {{json (t "rsvp_confirmed_no")}};

    var rsvpConfirmed = document.getElementById('rsvp-confirmed');
    var rsvpForm = document.getElementById('rsvp-form');

    function showConfirmation(data) {
        document.getElementById('confirm-name').textContent = data.firstName + ' ' + data.lastName;
        var icon = document.getElementById('confirm-icon');
        var title = document.getElementById('confirm-title');
        var msg = document.getElementById('confirm-message');
        if (data.attending) {
            icon.innerHTML = '&#x2713;';
            icon.className = 'confirmation-icon';
            title.textContent = confirmedYesMsg;
        } else {
            icon.innerHTML = '&#x2717;';
            icon.className = 'confirmation-icon confirmation-icon-cancel';
            title.textContent = confirmedNoMsg;
        }
        if (data.message) {
            msg.textContent = data.message;
            msg.style.display = '';
        } else {
            msg.style.display = 'none';
        }
        rsvpConfirmed.style.display = '';
        rsvpForm.style.display = 'none';
    }

    {{if $att}}
    // Save to localStorage after server-side confirmation
    try {
        localStorage.setItem(storageKey, JSON.stringify({
            email: {{json $att.Email}},
            firstName: {{json $att.FirstName}},
            lastName: {{json $att.LastName}},
            attending: {{json $att.Attending}}
        }));
    } catch(e) {}
    {{else}}
    // If returning user has a stored RSVP, auto-fetch their current response
    try {
        var storedRsvp = JSON.parse(localStorage.getItem(storageKey));
        if (storedRsvp && storedRsvp.email) {
            fetch('/rsvp/lookup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({event_id: eventId, email: storedRsvp.email})
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.found) {
                    // Pre-fill the form for when they click "change"
                    document.getElementById('first_name').value = data.first_name;
                    document.getElementById('last_name').value = data.last_name;
                    document.getElementById('email').value = data.email;
                    document.getElementById('phone').value = data.phone || '';
                    document.getElementById('message').value = data.message || '';
                    var radios = document.querySelectorAll('input[name=attending]');
                    radios.forEach(function(r) {
                        r.checked = (data.attending && r.value === 'yes') || (!data.attending && r.value === 'no');
                    });
                    // Show confirmation card
                    showConfirmation({
                        firstName: data.first_name,
                        lastName: data.last_name,
                        attending: data.attending,
                        message: data.message
                    });
                }
            })
            .catch(function() {});
        } else {
            // No stored RSVP, pre-fill basic info from localStorage
            var savedInfo = JSON.parse(localStorage.getItem(userInfoKey));
            if (savedInfo) {
                if (savedInfo.firstName) document.getElementById('first_name').value = savedInfo.firstName;
                if (savedInfo.lastName) document.getElementById('last_name').value = savedInfo.lastName;
                if (savedInfo.email) document.getElementById('email').value = savedInfo.email;
                if (savedInfo.phone) document.getElementById('phone').value = savedInfo.phone;
            }
        }
    } catch(e) {}
    {{end}}

    // Save user info as they type
    var saveTimer;
    function saveUserInfo() {
        clearTimeout(saveTimer);
        saveTimer = setTimeout(function() {
            try {
                localStorage.setItem(userInfoKey, JSON.stringify({
                    firstName: document.getElementById('first_name').value,
                    lastName: document.getElementById('last_name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value
                }));
            } catch(e) {}
        }, 500);
    }
    rsvpForm.addEventListener('input', saveUserInfo);

    // Change button â€” show form, hide confirmation
    document.getElementById('btn-change-rsvp').addEventListener('click', function() {
        rsvpConfirmed.style.display = 'none';
        rsvpForm.style.display = '';
    });
})();
</script>
{{end}}
{{template "layout" .}}
