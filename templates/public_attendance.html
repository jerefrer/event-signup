{{define "content"}}
{{$data := .Data}}
{{$event := index $data "Event"}}
{{$att := index $data "Attendance"}}

<div class="event-header">
    <h1>{{loc $event.TitleFR $event.TitleEN}}</h1>
    <div class="event-meta">
        <span class="event-meta-item">&#x1F4C5; {{formatDate $event.EventDate}}</span>
        {{if $event.EventTime}}
        <span class="event-meta-item">&#x1F552; {{formatTime $event.EventTime}}</span>
        {{end}}
    </div>
    {{$desc := loc $event.DescriptionFR $event.DescriptionEN}}
    {{if $desc}}
    <div class="event-description">{{nl2br $desc}}</div>
    {{end}}
</div>

<form id="rsvp-form" method="POST" action="/rsvp?lang={{lang}}" class="signup-unified">
    <input type="hidden" name="event_id" value="{{$event.ID}}">
    <section class="panel">
        <h2 class="panel-title">{{t "rsvp_title"}}</h2>
        <div class="panel-body">
            <div class="form-row">
                <div class="form-group">
                    <label for="first_name">{{t "registration_first_name"}} *</label>
                    <input type="text" id="first_name" name="first_name" required class="form-input" autocomplete="given-name" {{if $att}}value="{{$att.FirstName}}"{{end}}>
                </div>
                <div class="form-group">
                    <label for="last_name">{{t "registration_last_name"}} *</label>
                    <input type="text" id="last_name" name="last_name" required class="form-input" autocomplete="family-name" {{if $att}}value="{{$att.LastName}}"{{end}}>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="email">{{t "registration_email"}} *</label>
                    <input type="email" id="email" name="email" required class="form-input" autocomplete="email" {{if $att}}value="{{$att.Email}}"{{end}}>
                </div>
                <div class="form-group">
                    <label for="phone">{{t "registration_phone"}}</label>
                    <input type="tel" id="phone" name="phone" class="form-input" autocomplete="tel" {{if $att}}value="{{$att.Phone}}"{{end}}>
                </div>
            </div>

            <div class="form-group" style="margin-top:1rem;">
                <label style="font-weight:600;margin-bottom:0.5rem;display:block;">{{t "rsvp_attending_label"}} *</label>
                <div class="rsvp-toggle">
                    <input type="radio" name="attending" value="yes" id="att-yes" required {{if and $att $att.Attending}}checked{{end}}>
                    <label for="att-yes">{{t "rsvp_attending_yes"}}</label>
                    <input type="radio" name="attending" value="no" id="att-no" required {{if and $att (not $att.Attending)}}checked{{end}}>
                    <label for="att-no">{{t "rsvp_attending_no"}}</label>
                </div>
            </div>

            <div class="form-group" style="margin-top:1rem;">
                <label for="message">{{t "rsvp_message"}}</label>
                <textarea id="message" name="message" rows="3" class="form-input" placeholder="{{t "rsvp_message_placeholder"}}">{{if $att}}{{$att.Message}}{{end}}</textarea>
            </div>
        </div>
    </section>

    <button type="submit" class="btn btn-primary btn-block"><i class="fa-solid fa-check"></i> {{t "rsvp_submit"}}</button>
</form>

<script>
(function() {
    var eventSlug = {{json $event.Slug}};
    var storageKey = 'rsvp_' + eventSlug;
    var userInfoKey = 'user_info';
    var rsvpForm = document.getElementById('rsvp-form');

    {{if $att}}
    // Save to localStorage after server-side confirmation
    try {
        localStorage.setItem(storageKey, JSON.stringify({
            email: {{json $att.Email}},
            firstName: {{json $att.FirstName}},
            lastName: {{json $att.LastName}},
            attending: {{json $att.Attending}}
        }));
    } catch(e) {}
    {{else}}
    // Pre-fill from localStorage
    try {
        var savedInfo = JSON.parse(localStorage.getItem(userInfoKey));
        if (savedInfo) {
            if (savedInfo.firstName) document.getElementById('first_name').value = savedInfo.firstName;
            if (savedInfo.lastName) document.getElementById('last_name').value = savedInfo.lastName;
            if (savedInfo.email) document.getElementById('email').value = savedInfo.email;
            if (savedInfo.phone) document.getElementById('phone').value = savedInfo.phone;
        }
    } catch(e) {}
    {{end}}

    // Save user info as they type
    var saveTimer;
    function saveUserInfo() {
        clearTimeout(saveTimer);
        saveTimer = setTimeout(function() {
            try {
                localStorage.setItem(userInfoKey, JSON.stringify({
                    firstName: document.getElementById('first_name').value,
                    lastName: document.getElementById('last_name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value
                }));
            } catch(e) {}
        }, 500);
    }
    rsvpForm.addEventListener('input', saveUserInfo);
})();
</script>
{{end}}
{{template "layout" .}}
